#!/usr/bin/env bash
#SBATCH --job-name=TestParsing
#SBATCH --partition=nodes
#SBATCH --time=0-00:30:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=2
#SBATCH --mem=2G
#SBATCH --account=pet-hadron-2019
#SBATCH --output=%x-%j.log
#SBATCH --error=%x-%j.err

set -e

echo "=== Testing parsing macros on existing simulation file ==="
echo "Started at: $(date)"

# Load required modules
module purge
module load ROOT/6.30.06-foss-2023a

# Test directories
TEST_INPUT="/users/bp969/scratch/VIKING_FOLDER/SIMULATION_RUNNING/SCENARIO_4_SIM/out_seed_Scen4_8.root"
TEST_OUTPUT_DIR="/users/bp969/scratch/VIKING_FOLDER/SIMULATION_RESULTS/TEST_PARSING"
PARSING_DIR="/users/bp969/scratch/VIKING_FOLDER/DATA_PARSING"

# Create test output directory
mkdir -p "$TEST_OUTPUT_DIR"

# Change to parsing directory (where macros are located)
cd "$PARSING_DIR"

echo "Input file: $TEST_INPUT"
echo "Output directory: $TEST_OUTPUT_DIR"
echo "Working directory: $(pwd)"

# Check if input file exists
if [ ! -f "$TEST_INPUT" ]; then
    echo "ERROR: Input file $TEST_INPUT not found!"
    exit 1
fi

# Run acceptance analysis
echo "Running acceptance analysis..."
root -l -b -q "KLong_save_momentum_acceptance.C(\"$TEST_INPUT\")"

# Check if acceptance output was created
ACCEPTANCE_OUTPUT="out_seed_Scen4_8_acceptance.root"
if [ -f "$ACCEPTANCE_OUTPUT" ]; then
    echo "SUCCESS: Acceptance output created: $ACCEPTANCE_OUTPUT"
    # Move to test results directory
    mv "$ACCEPTANCE_OUTPUT" "$TEST_OUTPUT_DIR/"
    echo "Moved to: $TEST_OUTPUT_DIR/$ACCEPTANCE_OUTPUT"
else
    echo "ERROR: Expected acceptance output file not created!"
    ls -la
    exit 1
fi

# Run vector analysis
echo "Running vector analysis..."
root -l -b -q "KLong_save_vectors.C(\"$TEST_INPUT\")"

# Check if vectors output was created
VECTORS_OUTPUT="out_seed_Scen4_8_vectors.root"
if [ -f "$VECTORS_OUTPUT" ]; then
    echo "SUCCESS: Vectors output created: $VECTORS_OUTPUT"
    # Move to test results directory
    mv "$VECTORS_OUTPUT" "$TEST_OUTPUT_DIR/"
    echo "Moved to: $TEST_OUTPUT_DIR/$VECTORS_OUTPUT"
else
    echo "ERROR: Expected vectors output file not created!"
    ls -la
    exit 1
fi

echo "=== Verifying output files ==="
cd "$TEST_OUTPUT_DIR"
for file in *.root; do
    if [ -f "$file" ]; then
        size=$(stat -c%s "$file")
        echo "$file: $size bytes"
        if [ $size -gt 1000 ]; then
            echo "  ✓ File size looks good (>1KB)"
        else
            echo "  ✗ File size suspiciously small (<1KB)"
        fi
    fi
done

echo "=== Test completed successfully at: $(date) ==="