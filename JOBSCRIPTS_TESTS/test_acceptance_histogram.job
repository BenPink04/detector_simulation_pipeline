#!/usr/bin/env bash
#SBATCH --job-name=TestAcceptanceHistogram
#SBATCH --partition=nodes
#SBATCH --time=0-00:05:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --mem=2G
#SBATCH --account=pet-hadron-2019
#SBATCH --output=%x-%j.log
#SBATCH --error=%x-%j.err

set -e

module load ROOT/6.30.06-foss-2023a

echo "Testing acceptance histogram creation with existing data..."

cd /users/bp969/scratch/VIKING_FOLDER/HISTOGRAM_MAKING

# Find available combined acceptance files
ACCEPTANCE_FILES=($(find /users/bp969/scratch/VIKING_FOLDER/SIMULATION_RESULTS -name "*_combined_acceptance.root" | head -3))

echo "Found ${#ACCEPTANCE_FILES[@]} combined acceptance files:"
for file in "${ACCEPTANCE_FILES[@]}"; do
    echo "  - $file"
done

if [ ${#ACCEPTANCE_FILES[@]} -eq 0 ]; then
    echo "❌ No combined acceptance files found!"
    exit 1
fi

# Create a modified acceptance plotting script with the correct file path
TEST_FILE="${ACCEPTANCE_FILES[0]}"
echo "Using test file: $TEST_FILE"

cat > test_acceptance_plot.C << EOF
#include "TFile.h"
#include "TTree.h"
#include "TH1D.h"
#include "TCanvas.h"
#include <vector>
#include <iostream>
#include <string>

void test_acceptance_plot() {
    std::vector<std::string> filenames = {
        "$TEST_FILE"
    };

    double p_min = 0.0, p_max = 10.0;
    double bin_width = 0.5;
    int n_bins = int((p_max - p_min) / bin_width);
    std::vector<int> reco_in_bin(n_bins, 0);
    std::vector<int> total_in_bin(n_bins, 0);

    for (const auto& fname : filenames) {
        TFile *file = TFile::Open(fname.c_str());
        if (!file || file->IsZombie()) {
            std::cout << "Cannot open " << fname << "\\n";
            continue;
        }

        TTree *tree = (TTree*)file->Get("kaonEventInfo");
        if (!tree) {
            std::cout << "Tree kaonEventInfo not found in " << fname << "!\\n";
            file->Close();
            continue;
        }

        std::vector<double> *true_mom_vec = nullptr;
        std::vector<int> *reco_flag_vec = nullptr;
        int n_triple_pion_events = 0;
        tree->SetBranchAddress("true_mom_vec", &true_mom_vec);
        tree->SetBranchAddress("reco_flag_vec", &reco_flag_vec);
        tree->SetBranchAddress("n_triple_pion_events", &n_triple_pion_events);

        tree->GetEntry(0);

        std::cout << "Processing " << n_triple_pion_events << " kaon events...\\n";

        for (int i = 0; i < n_triple_pion_events; ++i) {
            double p = (*true_mom_vec)[i];
            int bin = int((p - p_min) / bin_width);
            if (bin < 0 || bin >= n_bins) continue;
            total_in_bin[bin]++;
            if ((*reco_flag_vec)[i]) {
                reco_in_bin[bin]++;
            }
        }
        file->Close();
    }

    TH1D *h_proportion = new TH1D("h_proportion", "Reconstruction Acceptance;True Momentum [GeV/c];Acceptance (Reconstructed/Total)", n_bins, p_min, p_max);

    int total_events = 0;
    int total_reconstructed = 0;
    
    for (int bin = 0; bin < n_bins; ++bin) {
        int reconstructed_vertices = reco_in_bin[bin];
        int total_vertices = total_in_bin[bin];
        
        total_events += total_vertices;
        total_reconstructed += reconstructed_vertices;
        
        double acceptance;
        if (total_vertices > 0) {
            acceptance = double(reconstructed_vertices) / double(total_vertices);
        } else {
            acceptance = 0.0;
        }
        
        h_proportion->SetBinContent(bin + 1, acceptance);
        
        if (total_vertices > 0) {
            std::cout << "Bin " << bin << " (p=" << p_min + bin*bin_width << "-" << p_min + (bin+1)*bin_width 
                      << " GeV/c): Total=" << total_vertices 
                      << ", Reconstructed=" << reconstructed_vertices 
                      << ", Acceptance=" << acceptance << std::endl;
        }
    }

    std::cout << "\\n=== SUMMARY ===" << std::endl;
    std::cout << "Total kaon events: " << total_events << std::endl;
    std::cout << "Total reconstructed: " << total_reconstructed << std::endl;
    std::cout << "Overall acceptance: " << (total_events > 0 ? (double)total_reconstructed/total_events : 0) << std::endl;

    // Create canvas and draw histogram
    TCanvas *c1 = new TCanvas("c1", "Kaon Acceptance", 800, 600);
    h_proportion->SetFillColor(kBlue-9);
    h_proportion->SetLineColor(kBlue+2);
    h_proportion->Draw("hist");
    c1->Update();

    // Save the plot
    gPad->SaveAs("test_acceptance_plot.png");
    std::cout << "\\nPlot saved as test_acceptance_plot.png" << std::endl;
    
    // Also save as ROOT file for later use
    TFile *outfile = new TFile("test_acceptance_histogram.root", "RECREATE");
    h_proportion->Write();
    c1->Write();
    outfile->Close();
    
    std::cout << "Histogram also saved as test_acceptance_histogram.root" << std::endl;
}
EOF

echo "Running acceptance histogram test..."
root -l -b -q "test_acceptance_plot.C()"

if [ -f "test_acceptance_plot.png" ]; then
    echo "✅ SUCCESS: Acceptance histogram created!"
    echo "Output files:"
    ls -la test_acceptance_plot.png test_acceptance_histogram.root 2>/dev/null || true
else
    echo "❌ FAILED: No histogram created"
fi

# Cleanup
rm -f test_acceptance_plot.C