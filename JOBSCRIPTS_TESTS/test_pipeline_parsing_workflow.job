#!/usr/bin/env bash
#SBATCH --job-name=TestPipelineParsing
#SBATCH --partition=nodes
#SBATCH --time=0-00:30:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=2
#SBATCH --mem=2G
#SBATCH --account=pet-hadron-2019
#SBATCH --output=%x-%j.log
#SBATCH --error=%x-%j.err

set -e

echo "=== Testing pipeline parsing workflow ==="
echo "Started at: $(date)"

# Load required modules
module purge
module load ROOT/6.30.06-foss-2023a

# Simulate pipeline structure
CONFIG_STR="TEST_T1-250_T2-260_T3-330_T4-340_P1-215_P2-230_F1-290_F2-300_E1-400"
RESULTS_DIR="/users/bp969/scratch/VIKING_FOLDER/SIMULATION_RESULTS/${CONFIG_STR}"
PARSING_DIR="/users/bp969/scratch/VIKING_FOLDER/DATA_PARSING/${CONFIG_STR}_DATA_READ"

# Create directories
mkdir -p "$RESULTS_DIR"
mkdir -p "$PARSING_DIR"

# Copy test simulation file to pipeline location with expected name
TEST_INPUT="/users/bp969/scratch/VIKING_FOLDER/SIMULATION_RUNNING/SCENARIO_4_SIM/out_seed_Scen4_8.root"
PIPELINE_INPUT="${RESULTS_DIR}/${CONFIG_STR}_1.root"

echo "Copying test file to pipeline structure..."
cp "$TEST_INPUT" "$PIPELINE_INPUT"

# Copy parsing macros to parsing directory
cp "/users/bp969/scratch/VIKING_FOLDER/DATA_PARSING/KLong_save_momentum_acceptance.C" "$PARSING_DIR/"
cp "/users/bp969/scratch/VIKING_FOLDER/DATA_PARSING/KLong_save_vectors.C" "$PARSING_DIR/"

# Change to parsing directory
cd "$PARSING_DIR"

echo "Input file: $PIPELINE_INPUT"
echo "Results directory: $RESULTS_DIR"
echo "Parsing directory: $(pwd)"

# Simulate the pipeline parsing logic
ACCEPTANCE_OUTPUT="${CONFIG_STR}_1_acceptance.root"
VECTORS_OUTPUT="${CONFIG_STR}_1_vectors.root"

# Run acceptance analysis
echo "Running acceptance analysis..."
root -l -b -q "KLong_save_momentum_acceptance.C(\"$PIPELINE_INPUT\")"

# Check and move acceptance output
if [ -f "$ACCEPTANCE_OUTPUT" ]; then
    echo "SUCCESS: Acceptance output created: $ACCEPTANCE_OUTPUT"
    mv "$ACCEPTANCE_OUTPUT" "$RESULTS_DIR/"
    echo "Moved to: $RESULTS_DIR/$ACCEPTANCE_OUTPUT"
else
    echo "ERROR: Expected acceptance output file $ACCEPTANCE_OUTPUT not created!"
    echo "Files in current directory:"
    ls -la
    exit 1
fi

# Run vector analysis
echo "Running vector analysis..."
root -l -b -q "KLong_save_vectors.C(\"$PIPELINE_INPUT\")"

# Check and move vectors output
if [ -f "$VECTORS_OUTPUT" ]; then
    echo "SUCCESS: Vectors output created: $VECTORS_OUTPUT"
    mv "$VECTORS_OUTPUT" "$RESULTS_DIR/"
    echo "Moved to: $RESULTS_DIR/$VECTORS_OUTPUT"
else
    echo "ERROR: Expected vectors output file $VECTORS_OUTPUT not created!"
    echo "Files in current directory:"
    ls -la
    exit 1
fi

echo "=== Verifying output files in results directory ==="
cd "$RESULTS_DIR"
for file in *_acceptance.root *_vectors.root; do
    if [ -f "$file" ]; then
        size=$(stat -c%s "$file")
        echo "$file: $size bytes"
        if [ $size -gt 1000 ]; then
            echo "  ✓ File size looks good (>1KB)"
            
            # Quick ROOT check to verify file structure
            echo "  Checking ROOT file structure..."
            root -l -b -q -e "
                TFile *f = TFile::Open(\"$file\");
                if(f && !f->IsZombie()) {
                    cout << \"  Trees: \";
                    TIter next(f->GetListOfKeys());
                    TKey *key;
                    while((key=(TKey*)next())) {
                        if(TString(key->GetClassName()).Contains(\"TTree\")) {
                            TTree *t = (TTree*)f->Get(key->GetName());
                            cout << key->GetName() << \"(\" << t->GetEntries() << \") \";
                        }
                    }
                    cout << endl;
                    f->Close();
                } else {
                    cout << \"  ERROR: Could not open file!\" << endl;
                }
            "
        else
            echo "  ✗ File size suspiciously small (<1KB)"
        fi
    fi
done

# Test hadd combination (like pipeline does)
echo "=== Testing hadd combination ==="
if [ -f "${CONFIG_STR}_1_acceptance.root" ] && [ -f "${CONFIG_STR}_1_vectors.root" ]; then
    echo "Testing hadd combination..."
    hadd -f "${CONFIG_STR}_combined_acceptance.root" ${CONFIG_STR}_[0-9]*_acceptance.root
    hadd -f "${CONFIG_STR}_combined_vectors.root" ${CONFIG_STR}_[0-9]*_vectors.root
    
    echo "Combined files created:"
    ls -la *_combined_*.root
fi

echo "=== Pipeline parsing test completed successfully at: $(date) ==="
echo "All files ready for plotting!"