#!/usr/bin/env bash
#SBATCH --job-name=VerifyTestOutput
#SBATCH --partition=nodes
#SBATCH --time=0-00:10:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --mem=1G
#SBATCH --account=pet-hadron-2019
#SBATCH --output=%x-%j.log
#SBATCH --error=%x-%j.err

set -e

echo "=== Verifying test parsing output contains data ==="
echo "Started at: $(date)"

# Load required modules
module purge
module load ROOT/6.30.06-foss-2023a

# Check the test output file
TEST_FILE="/users/bp969/scratch/VIKING_FOLDER/SIMULATION_RESULTS/TEST_T1-250_T2-260_T3-330_T4-340_P1-215_P2-230_F1-290_F2-300_E1-400/TEST_T1-250_T2-260_T3-330_T4-340_P1-215_P2-230_F1-290_F2-300_E1-400_1.root"

if [ ! -f "$TEST_FILE" ]; then
    echo "ERROR: Test file not found: $TEST_FILE"
    exit 1
fi

echo "Checking file: $TEST_FILE"
echo "File size: $(ls -lh "$TEST_FILE" | awk '{print $5}')"

# Detailed ROOT file inspection
root -l -b -q << EOF
TFile *f = TFile::Open("$TEST_FILE");
if (!f || f->IsZombie()) {
    cout << "ERROR: Could not open file!" << endl;
    return;
}

cout << "\n=== FILE STRUCTURE ===" << endl;
f->ls();

cout << "\n=== DETAILED TREE ANALYSIS ===" << endl;
TIter next(f->GetListOfKeys());
TKey *key;
while((key=(TKey*)next())) {
    if(TString(key->GetClassName()).Contains("TTree")) {
        cout << "\n--- Tree: " << key->GetName() << " ---" << endl;
        TTree *t = (TTree*)f->Get(key->GetName());
        if(t) {
            cout << "Entries: " << t->GetEntries() << endl;
            cout << "Branches:" << endl;
            TObjArray *branches = t->GetListOfBranches();
            for(int i=0; i<branches->GetEntries(); i++) {
                TBranch *br = (TBranch*)branches->At(i);
                cout << "  " << br->GetName() << " (" << br->GetClassName() << ")" << endl;
            }
            
            // Check if this looks like acceptance or vectors data
            if(TString(key->GetName()).Contains("kaonEventInfo")) {
                cout << "\n*** ACCEPTANCE DATA CHECK ***" << endl;
                t->SetScanField(0);
                cout << "First few entries (acceptance data):" << endl;
                t->Scan("n_triple_pion_events:true_mom_vec.size():reco_flag_vec.size()", "", "", 5);
                
                // Get first entry to check actual data
                t->GetEntry(0);
                int n_events;
                vector<double> *true_mom = 0;
                vector<int> *reco_flag = 0;
                t->SetBranchAddress("n_triple_pion_events", &n_events);
                t->SetBranchAddress("true_mom_vec", &true_mom);
                t->SetBranchAddress("reco_flag_vec", &reco_flag);
                t->GetEntry(0);
                
                cout << "Triple pion events: " << n_events << endl;
                if(true_mom) cout << "True momentum vector size: " << true_mom->size() << endl;
                if(reco_flag) cout << "Reco flag vector size: " << reco_flag->size() << endl;
                
                if(true_mom && true_mom->size() > 0) {
                    cout << "Sample true momenta (first 10): ";
                    for(int i=0; i<min(10, (int)true_mom->size()); i++) {
                        cout << (*true_mom)[i] << " ";
                    }
                    cout << endl;
                }
                
                if(reco_flag && reco_flag->size() > 0) {
                    int reconstructed = 0;
                    for(int i=0; i<reco_flag->size(); i++) {
                        if((*reco_flag)[i]) reconstructed++;
                    }
                    cout << "Reconstructed events: " << reconstructed << " / " << reco_flag->size();
                    cout << " (" << (100.0*reconstructed/reco_flag->size()) << "%)" << endl;
                }
            }
            
            if(TString(key->GetName()).Contains("kaonVectors")) {
                cout << "\n*** VECTORS DATA CHECK ***" << endl;
                t->SetScanField(0);
                cout << "First few entries (vectors data):" << endl;
                t->Scan("reco_p.size():true_p.size()", "", "", 5);
                
                // Get first entry to check actual data
                t->GetEntry(0);
                vector<double> *reco_p = 0;
                vector<double> *true_p = 0;
                t->SetBranchAddress("reco_p", &reco_p);
                t->SetBranchAddress("true_p", &true_p);
                t->GetEntry(0);
                
                if(reco_p) cout << "Reco momentum vector size: " << reco_p->size() << endl;
                if(true_p) cout << "True momentum vector size: " << true_p->size() << endl;
                
                if(reco_p && reco_p->size() > 0) {
                    cout << "Sample reco momenta (first 5): ";
                    for(int i=0; i<min(5, (int)reco_p->size()); i++) {
                        cout << (*reco_p)[i] << " ";
                    }
                    cout << endl;
                }
                
                if(true_p && true_p->size() > 0) {
                    cout << "Sample true momenta (first 5): ";
                    for(int i=0; i<min(5, (int)true_p->size()); i++) {
                        cout << (*true_p)[i] << " ";
                    }
                    cout << endl;
                }
            }
        }
    }
}

f->Close();
cout << "\n=== VERIFICATION COMPLETE ===" << endl;
EOF

echo "=== Summary ==="
echo "If you see data with:"
echo "  - n_triple_pion_events > 0"
echo "  - true_mom_vec with realistic momentum values (0.1-10 GeV/c)"
echo "  - Some reco_flag_vec entries = 1 (reconstructed events)"
echo "  - reco_p and true_p vectors with momentum data"
echo ""
echo "Then the parsing worked correctly and histograms will have data!"
echo ""
echo "Completed at: $(date)"