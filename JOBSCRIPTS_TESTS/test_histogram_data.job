#!/usr/bin/env bash
#SBATCH --job-name=TestHistogramData
#SBATCH --partition=nodes
#SBATCH --time=0-00:05:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --mem=2G
#SBATCH --account=pet-hadron-2019
#SBATCH --output=%x-%j.log
#SBATCH --error=%x-%j.err

set -e

module load ROOT/6.30.06-foss-2023a

echo "Testing histogram creation with combined vectors data..."

# Test file path
TEST_FILE="/users/bp969/scratch/VIKING_FOLDER/SIMULATION_RESULTS/T1-250_T2-260_T3-330_T4-340_P1-215_P2-230_F1-290_F2-300_E1-400/T1-250_T2-260_T3-330_T4-340_P1-215_P2-230_F1-290_F2-300_E1-400_combined_vectors.root"

echo "Using test file: $TEST_FILE"

# Check if file exists and get basic info
if [ -f "$TEST_FILE" ]; then
    echo "✅ File exists"
    FILESIZE=$(stat -c%s "$TEST_FILE" 2>/dev/null)
    echo "File size: $FILESIZE bytes"
    
    # Quick ROOT inspection
    echo "Inspecting ROOT file contents..."
    root -l -b -q -e "
        TFile* f = TFile::Open(\"$TEST_FILE\");
        if (!f || f->IsZombie()) {
            cout << \"❌ Cannot open file!\" << endl;
            exit(1);
        }
        
        f->ls();
        
        TTree* tree = (TTree*)f->Get(\"kaonVectors\");
        if (!tree) {
            cout << \"❌ Tree 'kaonVectors' not found!\" << endl;
            f->Close();
            exit(1);
        }
        
        cout << \"✅ Tree found with \" << tree->GetEntries() << \" entries\" << endl;
        tree->Print();
        
        // Check if branches exist
        if (tree->GetBranch(\"reco_p\") && tree->GetBranch(\"true_p\")) {
            cout << \"✅ Required branches 'reco_p' and 'true_p' found\" << endl;
            
            // Get first entry to check data
            std::vector<double>* reco_p = nullptr;
            std::vector<double>* true_p = nullptr;
            tree->SetBranchAddress(\"reco_p\", &reco_p);
            tree->SetBranchAddress(\"true_p\", &true_p);
            
            if (tree->GetEntries() > 0) {
                tree->GetEntry(0);
                if (reco_p && true_p) {
                    cout << \"✅ Data vectors loaded successfully\" << endl;
                    cout << \"   Number of reco_p values: \" << reco_p->size() << endl;
                    cout << \"   Number of true_p values: \" << true_p->size() << endl;
                    
                    if (reco_p->size() > 0 && true_p->size() > 0) {
                        cout << \"   Sample reco_p[0]: \" << (*reco_p)[0] << \" GeV/c\" << endl;
                        cout << \"   Sample true_p[0]: \" << (*true_p)[0] << \" GeV/c\" << endl;
                        cout << \"✅ Data looks valid for histogram creation!\" << endl;
                    } else {
                        cout << \"❌ Data vectors are empty!\" << endl;
                    }
                } else {
                    cout << \"❌ Failed to load data vectors!\" << endl;
                }
            } else {
                cout << \"❌ No entries in tree!\" << endl;
            }
        } else {
            cout << \"❌ Required branches not found!\" << endl;
        }
        
        f->Close();
    "
    
    echo ""
    echo "Now testing histogram creation script..."
    
    cd /users/bp969/scratch/VIKING_FOLDER/HISTOGRAM_MAKING
    
    # Copy the resolution script and modify it for our test file
    cp KLong_plot_resolution_histbar.C test_resolution_histbar.C
    
    # Update the file path in the script
    sed -i "s|/users/bp969/scratch/VIKING_FOLDER/SIMULATION_RESULTS/T1-250_T2-260_T3-330_T4-340_P1-215_P2-230_F1-290_F2-300_E1-400/T1-250_T2-260_T3-330_T4-340_P1-215_P2-230_F1-290_F2-300_E1-400_combined_vectors.root|$TEST_FILE|g" test_resolution_histbar.C
    
    echo "Running histogram creation script..."
    root -l -b -q "test_resolution_histbar.C()"
    
    if [ -f "KLong_histbar_plot.png" ]; then
        echo "✅ SUCCESS: Histogram created successfully!"
        echo "Plot saved as: $(pwd)/KLong_histbar_plot.png"
        ls -la KLong_histbar_plot.png
    else
        echo "❌ FAILED: No histogram plot created"
    fi
    
    # Cleanup
    rm -f test_resolution_histbar.C
    
else
    echo "❌ Test file does not exist: $TEST_FILE"
    exit 1
fi